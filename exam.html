<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Select Test</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
  body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f4f6f8; }
  
  /* Header */
  header { background: #1e88e5; color: white; padding: 15px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  .back-btn { font-size: 24px; cursor: pointer; background: none; border: none; color: white; }
  .title { font-size: 20px; font-weight: bold; text-transform: capitalize; }

  .container { padding: 15px; max-width: 600px; margin: 0 auto; }

  /* Grid for Buttons */
  .grid-menu { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 20px; }
  
  /* Buttons Styling */
  .menu-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    cursor: pointer;
    transition: 0.2s;
    border-left: 5px solid #1e88e5; /* Blue accent */
  }
  .menu-card:active { transform: scale(0.98); background: #e3f2fd; }
  
  .card-title { font-size: 17px; font-weight: 600; color: #333; text-transform: capitalize; }
  .icon { color: #1e88e5; font-weight: bold; }

  /* Specific Colors for Category */
  .cat-full { border-left-color: #fb8c00; } /* Orange for Full Test */
  .cat-topic { border-left-color: #43a047; } /* Green for Topic Wise */

  #loading { text-align: center; margin-top: 30px; color: #666; display: none; }
  #error-msg { color: red; text-align: center; margin-top: 20px; }
</style>
</head>

<body>

<header>
  <button class="back-btn" onclick="goBack()">&#8592;</button>
  <div class="title" id="page-title">Loading...</div>
</header>

<div class="container">
  <div id="loading">Fetching Data...</div>
  <div id="error-msg"></div>
  <div id="content-area" class="grid-menu"></div>
</div>

<script>
/* ================= CONFIGURATION ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBCuefZt2WuNsNiFme8M-HUHm_BZYKJAi4",
  authDomain: "career-care-afb64.firebaseapp.com",
  databaseURL: "https://career-care-afb64-default-rtdb.firebaseio.com",
  projectId: "career-care-afb64",
  storageBucket: "career-care-afb64.firebasestorage.app",
  messagingSenderId: "267890746286",
  appId: "1:267890746286:web:2c38f0980119d01b145e3f"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

/* ================= LOGIC START ================= */
const params = new URLSearchParams(window.location.search);
const examID = params.get('exam');     // e.g., first_grade
const typeID = params.get('type');     // e.g., topic_wise OR full_test
const subID = params.get('subject');   // e.g., history

const contentDiv = document.getElementById('content-area');
const titleDiv = document.getElementById('page-title');
const loader = document.getElementById('loading');

// 1. Initial Check
if (!examID) {
    showError("No Exam Selected.");
} else {
    initPage();
}

function initPage() {
    // SCENARIO 1: Sirf Exam select kiya hai (Show: Topic Wise vs Full Test)
    if (!typeID) {
        showCategories();
    } 
    // SCENARIO 2: Topic Wise select kiya, par Subject nahi (Show: History, Geography...)
    else if (typeID === 'topic_wise' && !subID) {
        fetchFromDB(`tests/${examID}/topic_wise`, "Subjects");
    } 
    // SCENARIO 3: Subject select kar liya (Show: Tests list inside History)
    else if (typeID === 'topic_wise' && subID) {
        fetchFromDB(`tests/${examID}/topic_wise/${subID}`, "Tests");
    } 
    // SCENARIO 4: Full Test select kiya (Show: Full Test 1, 2...)
    else if (typeID === 'full_test') {
        fetchFromDB(`tests/${examID}/full_test`, "Full Tests");
    }
}

/* --- Function 1: Show Main Categories --- */
function showCategories() {
    titleDiv.innerText = examID.replace(/_/g, " ") + " - Select Mode";
    
    contentDiv.innerHTML = `
        <div class="menu-card cat-topic" onclick="openLink('type', 'topic_wise')">
            <span class="card-title">üìö Topic Wise Tests</span>
            <span class="icon">‚ûî</span>
        </div>
        <div class="menu-card cat-full" onclick="openLink('type', 'full_test')">
            <span class="card-title">üìù Full Syllabus Tests</span>
            <span class="icon">‚ûî</span>
        </div>
    `;
}

/* --- Function 2: Fetch Lists from Firebase --- */
function fetchFromDB(path, pageName) {
    loader.style.display = "block";
    titleDiv.innerText = pageName;
    contentDiv.innerHTML = "";

    firebase.database().ref(path).once('value')
    .then(snapshot => {
        loader.style.display = "none";
        if (!snapshot.exists()) {
            showError("No content found here.");
            return;
        }

        const data = snapshot.val();
        Object.keys(data).forEach(key => {
            // Agar ye last level hai (Questions hain iske andar), to 'test.html' khulna chahiye
            // Agar folder hai (Subjects), to yahi page refresh hona chahiye
            
            // Check karne ka simple tareeka: Kya iske andar 'questions' folder hai?
            const isTest = data[key].hasOwnProperty('questions') || data[key].hasOwnProperty('q1') || Array.isArray(data[key]);

            let div = document.createElement('div');
            div.className = "menu-card";
            div.innerHTML = `
                <span class="card-title">${key.replace(/_/g, " ")}</span>
                <span class="icon">${isTest ? '‚ñ∂ Start' : 'üìÇ Open'}</span>
            `;

            div.onclick = () => {
                if (isTest) {
                    // Open the actual Test Page
                    // Path example: tests/first_grade/topic_wise/history/mughal_empire
                    // Lekin test.html ko 'exam' aur 'topic' param chahiye.
                    // Yahan logic thoda complex hai kyunki aapka test.html URL path se data leta hai.
                    
                    // Naya Logic for test.html URL:
                    // Hum path parameters bhejenge
                    let cleanPath = path.replace('tests/', ''); // Remove 'tests/' prefix
                    window.location.href = `test.html?exam=${cleanPath}&topic=${key}`;
                } else {
                    // Go Deeper (Example: Select Subject)
                    if(typeID === 'topic_wise') {
                        openLink('subject', key);
                    }
                }
            };
            contentDiv.appendChild(div);
        });
    })
    .catch(err => showError(err.message));
}

/* --- Helper Functions --- */
function openLink(paramKey, paramValue) {
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.set(paramKey, paramValue);
    window.location.href = currentUrl.toString();
}

function goBack() {
    // Back logic: Subject -> Category -> Home
    if (subID) {
        // Remove subject, go back to Subject List
        const url = new URL(window.location.href);
        url.searchParams.delete('subject');
        window.location.href = url.toString();
    } else if (typeID) {
        // Remove type, go back to Category List
        const url = new URL(window.location.href);
        url.searchParams.delete('type');
        window.location.href = url.toString();
    } else {
        // Go to Home
        window.location.href = "index.html";
    }
}

function showError(msg) {
    document.getElementById('error-msg').innerText = msg;
    loader.style.display = "none";
}
</script>

</body>
</html>
