<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Current Affairs Test</title>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1044688892570297" crossorigin="anonymous"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
  body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f4f6f8; }

  /* HEADER */
  header { background: #1e88e5; color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
  .header-left { display: flex; align-items: center; gap: 10px; }
  .back-btn { font-size: 24px; cursor: pointer; color: white; border: none; background: none; }
  .title { font-size: 18px; font-weight: bold; }
  
  /* Timer Badge */
  .timer-badge { background: white; color: #d32f2f; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 14px; display: none; }

  .container { padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 50px; }

  /* --- VIEW 1: HOME (List) --- */
  #home-view { display: block; }

  .hero-card {
      background: linear-gradient(135deg, #66bb6a, #43a047);
      color: white; padding: 25px; border-radius: 15px;
      text-align: center; cursor: pointer;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      margin-bottom: 25px; transition: transform 0.2s;
  }
  .hero-card:active { transform: scale(0.98); }
  .hero-title { font-size: 22px; font-weight: bold; margin-bottom: 5px; }
  .hero-date { font-size: 14px; opacity: 0.9; }

  .section-label { font-size: 16px; font-weight: bold; color: #555; margin-bottom: 10px; border-left: 4px solid #1e88e5; padding-left: 10px; }

  .quiz-list-item {
      background: white; padding: 15px; border-radius: 10px;
      margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; border: 1px solid #eee;
  }
  .list-date { font-weight: 600; color: #333; }
  .play-btn-small { color: #1e88e5; font-weight: bold; }

  /* --- VIEW 2: QUIZ INTERFACE (Test Mode) --- */
  #quiz-view { display: none; }
  
  .question-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); min-height: 200px; }
  .q-meta { display: flex; justify-content: space-between; color: #666; font-size: 14px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
  .q-text { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 20px; line-height: 1.5; }
  
  .option-btn { 
      display: block; width: 100%; padding: 15px; margin-bottom: 12px; 
      border: 2px solid #e0e0e0; border-radius: 10px; background: #fff; 
      font-size: 16px; text-align: left; cursor: pointer; transition: 0.2s;
  }
  .option-btn.selected { border-color: #1e88e5; background: #e3f2fd; color: #1565c0; font-weight: 600; }

  /* --- NAVIGATION BUTTONS (Updated Location) --- */
  .button-row { 
      margin-top: 20px; /* Space from Question Box */
      display: flex; justify-content: space-between; align-items: center; 
      gap: 10px;
  }
  .nav-btn { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.2s; }
  .nav-btn:active { transform: scale(0.98); }
  
  .btn-prev { background: #cfd8dc; color: #455a64; }
  .btn-skip { background: #fff3e0; color: #ef6c00; }
  .btn-next { background: #1e88e5; color: white; }
  .btn-submit { background: #43a047; color: white; }

  /* --- VIEW 3: RESULT VIEW --- */
  #result-view { display: none; }
  
  .score-card { 
      background: white; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 20px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
  }
  .score-big { font-size: 40px; font-weight: bold; color: #1e88e5; display: block; }
  
  .analysis-item { background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #eee; }
  .ans-status { font-size: 12px; font-weight: bold; padding: 3px 8px; border-radius: 4px; margin-bottom: 5px; display: inline-block; }
  .status-correct { background: #e8f5e9; color: #2e7d32; }
  .status-wrong { background: #ffebee; color: #c62828; }
  .status-skipped { background: #fff3e0; color: #ef6c00; }

  .correct-ans-box { background: #f1f8e9; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 14px; color: #33691e; }
  .explanation-box { margin-top: 10px; font-size: 14px; color: #555; border-left: 3px solid #ffca28; padding-left: 10px; }

  #main-loader { text-align: center; margin-top: 50px; font-weight: bold; color: #666; }
</style>
</head>
<body>

<header>
  <div class="header-left">
    <button class="back-btn" onclick="handleBack()">&#8592;</button>
    <div class="title" id="page-title">Current Affairs</div>
  </div>
  <div id="timer-display" class="timer-badge">00:00</div>
</header>

<div class="container">
  <div id="main-loader">üîÑ Loading...</div>

  <div id="home-view" style="display:none;">
      <div id="hero-section" style="display:none;">
          <div class="hero-card" onclick="startLatestQuiz()">
              <div class="hero-title">üöÄ Start Today's Test</div>
              <div class="hero-date" id="hero-date-text">Loading...</div>
          </div>
      </div>
      <div class="section-label">üìÖ Previous Tests</div>
      <div id="history-list"></div>
  </div>

  <div id="quiz-view">
      <div class="question-container">
          <div class="q-meta">
              <span id="q-number">Q 1/10</span>
              <span id="q-marks">+1 Mark</span>
          </div>
          <div id="q-content" class="q-text">Loading...</div>
          <div id="options-container"></div>
      </div>
      
      <div class="button-row">
          <button class="nav-btn btn-prev" onclick="prevQuestion()" id="btn-prev" disabled>Previous</button>
          <button class="nav-btn btn-skip" onclick="skipQuestion()">Skip</button>
          <button class="nav-btn btn-next" onclick="nextQuestion()" id="btn-next">Next</button>
      </div>
  </div>

  <div id="result-view">
      <div class="score-card">
          <h2>Test Submitted!</h2>
          <span class="score-big" id="final-score">0/0</span>
          <p id="time-taken">Time Taken: 00:00</p>
          <button class="nav-btn btn-next" onclick="handleBack()">Go Home</button>
      </div>
      <div class="section-label">üìù Detailed Analysis</div>
      <div id="analysis-container"></div>
  </div>

</div>

<script>
  /* CONFIG */
  const firebaseConfig = {
    apiKey: "AIzaSyBCuefZt2WuNsNiFme8M-HUHm_BZYKJAi4",
    authDomain: "career-care-afb64.firebaseapp.com",
    databaseURL: "https://career-care-afb64-default-rtdb.firebaseio.com",
    projectId: "career-care-afb64",
    appId: "1:267890746286:web:2c38f0980119d01b145e3f"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

  // State Variables
  let allDates = [];
  let currentQuestions = [];
  let currentQIndex = 0;
  let userAnswers = {}; // { 0: 2, 1: null, 2: 0 } (Index: OptionIndex)
  let timerInterval;
  let timeRemaining = 0;
  let totalTime = 0;

  /* 1. INITIALIZE */
  function init() {
      const dbRef = firebase.database().ref('daily_quiz');
      dbRef.orderByKey().limitToLast(30).once('value').then(snapshot => {
          document.getElementById("main-loader").style.display = "none";
          document.getElementById("home-view").style.display = "block";

          if(snapshot.exists()){
              const data = snapshot.val();
              allDates = Object.keys(data).sort().reverse(); 
              setupUI(allDates);
          } else {
              document.getElementById("history-list").innerHTML = "<p style='text-align:center'>No quizzes found.</p>";
          }
      });
  }

  /* 2. UI SETUP */
  function setupUI(dates) {
      if(dates.length > 0) {
          const latestDate = dates[0];
          document.getElementById("hero-section").style.display = "block";
          document.getElementById("hero-date-text").innerText = formatDateFull(latestDate);
          
          const listDiv = document.getElementById("history-list");
          listDiv.innerHTML = ""; 
          
          dates.slice(1).forEach(date => {
              const item = document.createElement("div");
              item.className = "quiz-list-item";
              item.innerHTML = `<div class="list-date">üìÖ ${formatDateShort(date)}</div><div class="play-btn-small">Start Test ‚ñ∂Ô∏è</div>`;
              item.onclick = () => loadQuiz(date);
              listDiv.appendChild(item);
          });
      }
  }

  function startLatestQuiz() {
      if(allDates.length > 0) loadQuiz(allDates[0]);
  }

  /* 3. LOAD QUIZ & START TEST */
  function loadQuiz(dateKey) {
      document.getElementById("main-loader").style.display = "block";
      document.getElementById("home-view").style.display = "none";

      firebase.database().ref(`daily_quiz/${dateKey}`).once('value').then(snap => {
          document.getElementById("main-loader").style.display = "none";
          
          if(snap.exists() && snap.val().questions) {
              const qData = snap.val().questions;
              currentQuestions = Array.isArray(qData) ? qData : Object.values(qData);
              
              currentQIndex = 0;
              userAnswers = {};
              
              totalTime = currentQuestions.length * 45; 
              timeRemaining = totalTime;
              
              document.getElementById("quiz-view").style.display = "block";
              document.getElementById("page-title").innerText = "Test Mode";
              startTimer();
              renderQuestion();
          } else {
              alert("No questions in this test.");
              handleBack();
          }
      });
  }

  /* 4. RENDER SINGLE QUESTION */
  function renderQuestion() {
      const q = currentQuestions[currentQIndex];
      
      document.getElementById("q-number").innerText = `Q ${currentQIndex + 1}/${currentQuestions.length}`;
      document.getElementById("q-content").innerText = q.question;
      
      const optContainer = document.getElementById("options-container");
      optContainer.innerHTML = "";
      
      if(q.options) {
          q.options.forEach((optText, i) => {
              const btn = document.createElement("button");
              btn.className = "option-btn";
              btn.innerText = optText;
              
              if(userAnswers[currentQIndex] === i) {
                  btn.classList.add("selected");
              }
              
              btn.onclick = () => selectOption(i);
              optContainer.appendChild(btn);
          });
      }

      document.getElementById("btn-prev").disabled = (currentQIndex === 0);
      const nextBtn = document.getElementById("btn-next");
      if(currentQIndex === currentQuestions.length - 1) {
          nextBtn.innerText = "Submit Test";
          nextBtn.classList.remove("btn-next");
          nextBtn.classList.add("btn-submit");
      } else {
          nextBtn.innerText = "Next";
          nextBtn.classList.remove("btn-submit");
          nextBtn.classList.add("btn-next");
      }
  }

  function selectOption(optIndex) {
      userAnswers[currentQIndex] = optIndex;
      renderQuestion();
  }

  /* 5. NAVIGATION */
  function nextQuestion() {
      if(currentQIndex === currentQuestions.length - 1) {
          finishQuiz();
      } else {
          currentQIndex++;
          renderQuestion();
      }
  }

  function prevQuestion() {
      if(currentQIndex > 0) {
          currentQIndex--;
          renderQuestion();
      }
  }

  function skipQuestion() {
      if(userAnswers[currentQIndex] === undefined) {
          userAnswers[currentQIndex] = null;
      }
      nextQuestion();
  }

  /* 6. TIMER LOGIC */
  function startTimer() {
      const timerBadge = document.getElementById("timer-display");
      timerBadge.style.display = "block";
      
      clearInterval(timerInterval);
      updateTimerDisplay();
      
      timerInterval = setInterval(() => {
          timeRemaining--;
          updateTimerDisplay();
          
          if(timeRemaining <= 0) {
              clearInterval(timerInterval);
              alert("Time's Up! Submitting Test automatically.");
              finishQuiz();
          }
      }, 1000);
  }

  function updateTimerDisplay() {
      const m = Math.floor(timeRemaining / 60);
      const s = timeRemaining % 60;
      document.getElementById("timer-display").innerText = `${m}:${s < 10 ? '0'+s : s}`;
  }

  /* 7. FINISH & RESULTS */
  function finishQuiz() {
      clearInterval(timerInterval);
      document.getElementById("quiz-view").style.display = "none";
      document.getElementById("timer-display").style.display = "none";
      document.getElementById("result-view").style.display = "block";
      document.getElementById("page-title").innerText = "Result";

      let score = 0;
      const analysisDiv = document.getElementById("analysis-container");
      analysisDiv.innerHTML = "";

      currentQuestions.forEach((q, index) => {
          const userAns = userAnswers[index];
          const correctAns = q.correctAnswer;
          
          let statusHtml = "";
          let cardClass = "analysis-item";

          if(userAns === correctAns) {
              score++;
              statusHtml = `<span class="ans-status status-correct">Correct ‚úÖ</span>`;
          } else if(userAns === null || userAns === undefined) {
              statusHtml = `<span class="ans-status status-skipped">Skipped ‚è≠Ô∏è</span>`;
          } else {
              statusHtml = `<span class="ans-status status-wrong">Wrong ‚ùå (You selected: ${q.options[userAns]})</span>`;
          }

          const card = document.createElement("div");
          card.className = cardClass;
          card.innerHTML = `
              ${statusHtml}
              <div style="font-weight:600; margin-bottom:5px;">Q${index+1}. ${q.question}</div>
              <div class="correct-ans-box">Correct Answer: ${q.options[correctAns]}</div>
              <div class="explanation-box"><b>üí° Logic:</b> ${q.explanation || "N/A"}</div>
          `;
          analysisDiv.appendChild(card);
      });

      document.getElementById("final-score").innerText = `${score}/${currentQuestions.length}`;
      const timeTaken = totalTime - timeRemaining;
      const tm = Math.floor(timeTaken / 60);
      const ts = timeTaken % 60;
      document.getElementById("time-taken").innerText = `Time Taken: ${tm}m ${ts}s`;
  }

  function handleBack() {
      if(document.getElementById("home-view").style.display === "block") {
          window.location.href = "index.html";
      } else {
          location.reload(); 
      }
  }

  function formatDateFull(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  }

  function formatDateShort(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
  }

  init();
</script>

</body>
</html>
