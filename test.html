<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Professional Quiz</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
  body{margin:0;font-family:'Segoe UI', sans-serif;background:#f4f6f8; padding-bottom: 60px;} /* Padding for bottom Ad */
  
  /* HEADER & PROGRESS */
  header{background:#1e88e5;color:#fff;padding:15px;text-align:center;font-weight:bold;font-size:18px; position: relative;}
  .progress-bar { height: 5px; background: #90caf9; width: 100%; position: absolute; bottom: 0; left: 0; }
  .progress-fill { height: 100%; background: #ffeb3b; width: 0%; transition: width 0.3s; }

  .container{padding:15px; max-width: 800px; margin: 0 auto;}
  
  /* TIMER & INFO */
  .info-bar { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; color: #444; }
  .timer-box { background: #fff3e0; color: #e65100; padding: 5px 10px; border-radius: 4px; border: 1px solid #ffb74d; }
  
  /* QUESTION CARD */
  .question-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
  .q-text { font-size: 18px; margin-bottom: 20px; color: #222; font-weight: 500; line-height: 1.5; }
  
  /* OPTIONS */
  .option{background:#f8f9fa;border:2px solid #e9ecef;padding:15px;margin-bottom:10px;border-radius:8px;cursor:pointer; transition: all 0.2s;}
  .option:hover { background: #e3f2fd; border-color: #90caf9; }
  .option.selected{background:#e3f2fd;border-color:#1e88e5; font-weight: bold; color: #1565c0;}
  
  /* REVIEW COLORS */
  .correct{background:#dcedc8!important; border-color: #8bc34a!important;}
  .wrong{background:#ffcdd2!important; border-color: #e57373!important;}

  /* BUTTONS */
  .footer-btns { display: flex; gap: 10px; margin-top: 20px; }
  .btn{flex:1; padding:12px; border:none; border-radius:6px; font-size:16px; cursor:pointer; font-weight: bold; color: white; transition: 0.2s opacity;}
  .btn:active { opacity: 0.8; }
  .prev{background:#78909c}
  .next{background:#1e88e5}
  .submit{background:#43a047; display: none;} /* Hidden initially */

  /* ADS SECTIONS */
  .ad-banner { width: 100%; background: #eee; text-align: center; padding: 10px; color: #999; font-size: 12px; margin: 10px 0; border: 1px dashed #ccc; }
  .ad-bottom-fixed { position: fixed; bottom: 0; left: 0; width: 100%; height: 50px; background: #fff; border-top: 1px solid #ccc; z-index: 100; display: flex; justify-content: center; align-items: center;}

  /* RESULT SECTION */
  #result-screen { display: none; text-align: center; }
  .rank-badge { background: #673ab7; color: white; padding: 5px 15px; border-radius: 20px; display: inline-block; margin-bottom: 10px; font-size: 14px;}
  .score-circle { width: 160px; height: 120px; background: #1e88e5; color: white; font-size: 32px; line-height: 120px; border-radius: 50%; margin: 10px auto; font-weight: bold; }
  
  #loader { text-align: center; margin-top: 50px; }
</style>
</head>
<body>

<div class="ad-banner">
  üì¢ Space for Top Banner Ad
</div>

<header>
  <span id="exam-title">Test Loading...</span>
  <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
</header>

<div class="container">
  
  <div id="loader">üîÑ Fetching Questions...</div>
  <div id="error-box" style="display:none; color:red; text-align:center;"></div>

  <div id="quiz-interface" style="display:none;">
    
    <div class="info-bar">
      <span>Q: <span id="q-num">1</span>/<span id="q-total">0</span></span>
      <div class="timer-box">‚è≥ <span id="timer">00:00</span></div>
    </div>

    <div class="question-card">
      <div class="q-text" id="q-text"></div>
      <div id="options-container"></div>
    </div>

    <div class="ad-banner" style="margin-top:20px;">
       üì¢ Space for Middle Ad
    </div>

    <div class="footer-btns">
      <button class="btn prev" onclick="prevQ()">‚¨Ö Prev</button>
      <button class="btn next" id="btn-next" onclick="nextQ()">Next ‚û°</button>
      <button class="btn submit" id="btn-submit" onclick="submitTest()">‚úÖ Submit</button>
    </div>
  </div>

  <div id="result-screen">
    <h2>Result Analysis</h2>
    <div class="rank-badge" id="rank-display">Calculating Rank...</div>
    
    <div class="score-circle" id="final-score">0/0</div>
    
    <div style="margin-top:20px;">
      <button class="btn next" onclick="window.location.reload()">üîÑ Retake Test</button>
      <button class="btn prev" onclick="window.location.href='index.html'">üè† Home</button>
    </div>

    <h3 style="text-align:left; margin-top:30px;">üìù Solution Review</h3>
    <div id="review-list" style="text-align:left;"></div>
  </div>

</div>

<div class="ad-bottom-fixed">
   üì¢ Space for Sticky Footer Ad
</div>

<script>
/* ================= CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBCuefZt2WuNsNiFme8M-HUHm_BZYKJAi4",
  authDomain: "career-care-afb64.firebaseapp.com",
  databaseURL: "https://career-care-afb64-default-rtdb.firebaseio.com",
  projectId: "career-care-afb64",
  appId: "1:267890746286:web:2c38f0980119d01b145e3f"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

/* ================= LOGIC ================= */
const params = new URLSearchParams(window.location.search);
const exam = params.get("exam");
const topic = params.get("topic");

let questions = [];
let current = 0;
let userAnswers = {};
let timeLeft = 0;
let timerInterval;

// Start
if(exam && topic) {
    loadData();
} else {
    document.getElementById("loader").innerText = "‚ö†Ô∏è Invalid URL parameters.";
}

function loadData() {
    // 1. Path Decision (Daily vs Standard)
    let dbPath = (exam === 'current_affairs') ? `daily_quiz/${topic}/questions` : `tests/${exam}/${topic}/questions`;
    
    firebase.database().ref(dbPath).once('value').then(snap => {
        document.getElementById("loader").style.display = "none";
        if(!snap.exists()){
            document.getElementById("error-box").innerText = "No questions found.";
            document.getElementById("error-box").style.display="block";
            return;
        }

        let data = snap.val();
        questions = Array.isArray(data) ? data.filter(x=>x) : Object.values(data);
        
        // SETUP UI
        document.getElementById("quiz-interface").style.display = "block";
        document.getElementById("q-total").innerText = questions.length;
        document.getElementById("exam-title").innerText = topic.replace(/_/g, " ").toUpperCase();

        // 1. REQ: Timer = 45 sec per question
        timeLeft = questions.length * 45; 
        startTimer();

        loadQuestion(0);
    });
}

function loadQuestion(index) {
    current = index;
    const q = questions[index];
    
    // Progress Bar
    let pct = ((index+1) / questions.length) * 100;
    document.getElementById("progress-fill").style.width = `${pct}%`;

    // Question Text (Handle 'q' vs 'question')
    document.getElementById("q-text").innerText = `Q${index+1}. ` + (q.question || q.q);
    document.getElementById("q-num").innerText = index + 1;

    // Options
    const div = document.getElementById("options-container");
    div.innerHTML = "";
    
    let opts = q.options; // Can be Array or Object
    let optsKeys = Array.isArray(opts) ? opts.map((_,i)=>i) : Object.keys(opts); // [0,1,2,3] or ["a","b"]

    optsKeys.forEach(key => {
        let val = Array.isArray(opts) ? opts[key] : opts[key]; // Text value
        
        let btn = document.createElement("div");
        btn.className = "option";
        if(userAnswers[index] == key) btn.classList.add("selected");
        btn.innerText = val;
        btn.onclick = () => {
            userAnswers[index] = key;
            loadQuestion(index); // Refresh to show selection
        };
        div.appendChild(btn);
    });

    // 2. REQ: Last Question Logic
    if(index === questions.length - 1) {
        document.getElementById("btn-next").style.display = "none";
        document.getElementById("btn-submit").style.display = "block";
    } else {
        document.getElementById("btn-next").style.display = "block";
        document.getElementById("btn-submit").style.display = "none";
    }
}

function nextQ() { if(current < questions.length - 1) loadQuestion(current + 1); }
function prevQ() { if(current > 0) loadQuestion(current - 1); }

function startTimer() {
    timerInterval = setInterval(() => {
        if(timeLeft <= 0) {
            submitTest();
        } else {
            timeLeft--;
            let m = Math.floor(timeLeft / 60);
            let s = timeLeft % 60;
            document.getElementById("timer").innerText = `${m}:${s<10?'0':''}${s}`;
        }
    }, 1000);
}

function submitTest() {
    clearInterval(timerInterval);
    document.getElementById("quiz-interface").style.display = "none";
    document.getElementById("result-screen").style.display = "block";

    let score = 0;
    questions.forEach((q, i) => {
        // Handle Answer Key (Index vs String)
        let correct = q.correctAnswer !== undefined ? q.correctAnswer : q.answer;
        if(userAnswers[i] == correct) score++;
        else if(userAnswers[i] !== undefined) score -= 0.33; // Negative marking
    });

    // Ensure score is not negative for display
    let displayScore = score < 0 ? 0 : score;
    document.getElementById("final-score").innerText = `${displayScore.toFixed(2)}/${questions.length}`;

    // 3. Save History (Real) & Show Rank (Simulated)
    saveResult(displayScore);
    
    // Yahan hum SIMULATED rank call kar rahe hain
    calculateSimulatedRank(displayScore, questions.length);

    generateReview();
}

function saveResult(score) {
    const userUid = localStorage.getItem("userUid") || "guest";
    
    // Only Save History (Rank ab fake dikha rahe hain, to leaderboard save zaroori nahi for display)
    if(userUid !== "guest") {
        firebase.database().ref(`students/${userUid}/history`).push({
            exam: exam,
            topic: topic,
            score: score.toFixed(2),
            date: new Date().toISOString()
        });
    }
}

// === NEW: SIMULATED RANK LOGIC (Fake User System) ===
function calculateSimulatedRank(score, totalQuestions) {
    // 1. Fake Total Students (e.g. 1500 se 3500 ke beech random)
    const fakeTotalStudents = Math.floor(Math.random() * (7500 - 1500 + 1)) + 1500;
    
    // 2. Percentage Nikalo
    let safeScore = score < 0 ? 0 : score;
    const percentage = safeScore / totalQuestions;

    // 3. Rank Calculate karo (High score = Low Rank Number)
    let estimatedRank = Math.floor(fakeTotalStudents * (1 - percentage));
    
    // 4. Thoda Logic: Agar full marks hain to Rank 1-10 mein ho
    if (estimatedRank < 1) estimatedRank = Math.floor(Math.random() * 10) + 1;
    if (estimatedRank > fakeTotalStudents) estimatedRank = fakeTotalStudents;

    // 5. Display
    document.getElementById("rank-display").innerText = `üèÜ Rank: ${estimatedRank} / ${fakeTotalStudents}`;
}

function generateReview() {
    const list = document.getElementById("review-list");
    questions.forEach((q, i) => {
        let correct = q.correctAnswer !== undefined ? q.correctAnswer : q.answer;
        let uAns = userAnswers[i];
        
        let statusColor = (uAns == correct) ? "green" : "red";
        
        let div = document.createElement("div");
        div.style = `background:white; padding:10px; margin-bottom:10px; border-left:4px solid ${statusColor}; box-shadow:0 2px 5px #eee;`;
        div.innerHTML = `
            <div style="font-weight:bold">Q${i+1}. ${q.question || q.q}</div>
            <div style="font-size:14px; color:#555; margin-top:5px;">
               Your Ans: <b>${uAns !== undefined ? uAns : "Skipped"}</b> | 
               Correct: <b style="color:green">${correct}</b>
            </div>
            <div style="background:#fff9c4; font-size:13px; padding:5px; margin-top:5px;">
               üí° ${q.explanation || "No explanation available."}
            </div>
        `;
        list.appendChild(div);
    });
}
</script>

</body>
</html>
