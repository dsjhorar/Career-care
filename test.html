<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Career Care Test</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
/* CSS Styles */
body{margin:0;font-family:Arial;background:#f4f6f8}
header{background:#1e88e5;color:#fff;padding:12px;text-align:center;font-size:18px}
.container{padding:15px}
.timer{background:#fb8c00;color:#fff;padding:8px;text-align:center;border-radius:6px;margin-bottom:10px;font-weight:bold}
.question{font-size:17px;margin-bottom:12px; line-height: 1.5;}
.option{background:#fff;border:1px solid #ddd;padding:12px;margin-bottom:8px;border-radius:6px;cursor:pointer}
.option.selected{background:#e3f2fd;border-color:#1e88e5}
.correct{background:#c8e6c9!important}
.wrong{background:#ffcdd2!important}
.btn{width:100%;padding:14px;margin-top:10px;border:none;border-radius:6px;color:#fff;font-size:16px;cursor:pointer}
.prev{background:#5c6bc0}
.skip{background:#fbc02d;color:#000}
.next{background:#43a047}
.submit{background:#d32f2f}
.explanation{background:#fffde7;border:1px solid #fbc02d;padding:10px;margin-top:6px;border-radius:6px;font-size:14px}
hr{margin:15px 0}
#error-box { color: red; background: #ffebee; padding: 10px; border: 1px solid red; display: none; margin-bottom: 10px; }
</style>
</head>

<body>

<header id="testTitle">Test Loading...</header>

<div class="container">
    <div id="error-box"></div>
    <div class="timer">Time: <span id="time">00:00</span></div>

    <div id="quiz">
      <div class="question" id="question">Connecting to Server...</div>
      <div id="options"></div>

      <button class="btn prev" onclick="prevQuestion()">‚¨Ö Previous</button>
      <button class="btn skip" onclick="skipQuestion()">‚è≠ Skip</button>
      <button class="btn next" onclick="nextQuestion()">Next ‚û°</button>
      <button class="btn submit" onclick="finishTest()">Submit Test</button>
    </div>

    <div id="result" style="display:none">
      <h2>Result Analysis</h2>
      <p id="scoreText"></p>
      <div id="review"></div>
      <button class="btn next" onclick="location.href='index.html'">Go Home</button>
      <button class="btn prev" onclick="location.href='history.html'">View History</button>
    </div>
</div>

<script>
/* ==============================================
   1. CONFIGURATION (Apni Key Yahan Dalein)
   ============================================== */
const firebaseConfig = {
  apiKey: "AIzaSyBCuefZt2WuNsNiFme8M-HUHm_BZYKJAi4",
  authDomain: "career-care-afb64.firebaseapp.com",
  databaseURL: "https://career-care-afb64-default-rtdb.firebaseio.com",
  projectId: "career-care-afb64",
  storageBucket: "career-care-afb64.firebasestorage.app",
  messagingSenderId: "267890746286",
  appId: "1:267890746286:web:2c38f0980119d01b145e3f"
};
// Initialize Firebase
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

/* ==============================================
   2. SECURITY CHECK (Premium Gatekeeper)
   ============================================== */
const isPremiumUser = localStorage.getItem("isPremium") === "true";
const currentUrl = window.location.href;

// Agar test URL mein "full_test" hai aur user Premium nahi hai
if (currentUrl.includes("full_test") && !isPremiumUser) {
    alert("üîí Ye Content Locked hai!\nIs test ko dene ke liye Premium Plan upgrade karein.");
    window.location.href = "premium.html";
}

/* ==============================================
   3. TEST LOGIC
   ============================================== */
const params = new URLSearchParams(window.location.search);
const exam = params.get("exam");
const topic = params.get("topic");

let questions = [];
let current = 0;
let userAnswers = {};
let score = 0;
let time = 10 * 60; // 10 Minutes
let timer;

// -- Start Execution --
if (!exam || !topic) {
    showError("URL Error: Exam or Topic missing.");
} else {
    // Path example: tests/first_grade/topic_wise/history/mughal_empire/questions
    const dbPath = `tests/${exam}/${topic}/questions`;
    document.getElementById("question").innerText = "Loading Questions...";
    
    firebase.database().ref(dbPath).once("value")
    .then(snapshot => {
        if (!snapshot.exists()) {
            showError("No questions found.");
            return;
        }
        let data = snapshot.val();
        questions = Array.isArray(data) ? data.filter(q=>q) : Object.values(data);
        
        if(!questions.length) {
            showError("Folder is empty.");
            return;
        }

        document.getElementById("testTitle").innerText = topic.replace(/_/g, " ").toUpperCase();
        loadQuestion();
        startTimer();
    })
    .catch(error => {
        showError("Error: " + error.message);
    });
}

/* ================= HELPER FUNCTIONS ================= */

function loadQuestion(){
    const q = questions[current];
    document.getElementById("question").innerText = `Q${current+1}. ${q.q}`;
    const optDiv = document.getElementById("options");
    optDiv.innerHTML = "";
    
    Object.keys(q.options).forEach(key => {
        let btn = document.createElement("div");
        btn.className = "option " + (userAnswers[current] === key ? "selected" : "");
        btn.innerText = q.options[key];
        btn.onclick = () => { userAnswers[current] = key; loadQuestion(); };
        optDiv.appendChild(btn);
    });
}

function nextQuestion(){
    if(current < questions.length - 1) { current++; loadQuestion(); }
}
function prevQuestion(){
    if(current > 0) { current--; loadQuestion(); }
}
function skipQuestion(){
    nextQuestion();
}

function finishTest(){
    clearInterval(timer);
    document.getElementById("quiz").style.display = "none";
    document.getElementById("result").style.display = "block";
    
    // Calculate Score
    questions.forEach((q, i) => {
        if(userAnswers[i] == q.answer) score++;
        else if(userAnswers[i]) score -= 0.33; // Negative marking
    });
    
    document.getElementById("scoreText").innerText = `Score: ${score.toFixed(2)} / ${questions.length}`;
    
    // === SAVE HISTORY (NEW FEATURE) ===
    const userUid = localStorage.getItem("userUid");
    if(userUid) {
        const historyRef = firebase.database().ref(`students/${userUid}/history`);
        historyRef.push({
            exam: exam,
            topic: topic,
            score: score.toFixed(2),
            totalQ: questions.length,
            date: new Date().toLocaleDateString(),
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    }
    // ==================================

    showReview();
}

function showReview(){
    const rev = document.getElementById("review");
    rev.innerHTML = "";
    questions.forEach((q, i) => {
        let ansStatus = userAnswers[i] == q.answer ? "correct" : (userAnswers[i] ? "wrong" : "");
        let html = `<div><b>Q${i+1}. ${q.q}</b></div>`;
        Object.keys(q.options).forEach(k => {
            let cls = "";
            if(k == q.answer) cls = "correct";
            else if(userAnswers[i] == k) cls = "wrong";
            html += `<div class="option ${cls}">${q.options[k]}</div>`;
        });
        html += `<div class="explanation">Logic: ${q.explanation || "N/A"}</div><hr>`;
        rev.innerHTML += html;
    });
}

function startTimer(){
    timer = setInterval(() => {
        if(time-- <= 0) finishTest();
        let m = Math.floor(time / 60), s = time % 60;
        document.getElementById("time").innerText = `${m}:${s<10?"0":""}${s}`;
    }, 1000);
}

function showError(msg) {
    document.getElementById("error-box").style.display = "block";
    document.getElementById("error-box").innerText = msg;
    document.getElementById("question").innerText = "Loading Failed.";
}
</script>

</body>
</html>
