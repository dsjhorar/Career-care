<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script src="firebase.js"></script>

<style>
/* CSS Same as before */
body{margin:0;font-family:Arial;background:#f4f6f8}
header{background:#1e88e5;color:#fff;padding:12px;text-align:center;font-size:18px}
.container{padding:15px}
.timer{background:#fb8c00;color:#fff;padding:8px;text-align:center;border-radius:6px;margin-bottom:10px;font-weight:bold}
.question{font-size:17px;margin-bottom:12px}
.option{background:#fff;border:1px solid #ddd;padding:12px;margin-bottom:8px;border-radius:6px;cursor:pointer}
.option.selected{background:#e3f2fd;border-color:#1e88e5}
.correct{background:#c8e6c9!important}
.wrong{background:#ffcdd2!important}
.btn{width:100%;padding:14px;margin-top:10px;border:none;border-radius:6px;color:#fff;font-size:16px;cursor:pointer}
.prev{background:#5c6bc0}
.skip{background:#fbc02d;color:#000}
.next{background:#43a047}
.submit{background:#d32f2f}
.explanation{background:#fffde7;border:1px solid #fbc02d;padding:10px;margin-top:6px;border-radius:6px;font-size:14px}
hr{margin:15px 0}
</style>
</head>

<body>

<header id="testTitle">Loading Test...</header>

<div class="container">
    <div class="timer">Time: <span id="time">00:00</span></div>

    <div id="quiz">
      <div class="question" id="question">Preparing environment...</div>
      <div id="options"></div>

      <button class="btn prev" onclick="prevQuestion()">⬅ Previous</button>
      <button class="btn skip" onclick="skipQuestion()">⏭ Skip</button>
      <button class="btn next" onclick="nextQuestion()">Next ➡</button>
      <button class="btn submit" onclick="finishTest()">Submit Test</button>
    </div>

    <div id="result" style="display:none">
      <h2>Test Analysis</h2>
      <p id="scoreText"></p>
      <div id="review"></div>
      <button class="btn next" onclick="location.href='index.html'">Go Home</button>
    </div>
</div>

<script>
/* ================= URL PARAMS CHECK ================= */
const params = new URLSearchParams(window.location.search);
const exam = params.get("exam");
const topic = params.get("topic");

console.log("Exam:", exam); // Debugging
console.log("Topic:", topic); // Debugging

/* ================= VARIABLES ================= */
let questions = [];
let current = 0;
let userAnswers = {};
let score = 0;
let time = 10 * 60;
let timer;

/* ================= INITIALIZATION & LOADING ================= */
// Check if URL parameters exist BEFORE calling database
if (!exam || !topic) {
    document.getElementById("question").innerHTML = 
        "<b>Error:</b> URL parameters missing.<br>URL should look like:<br><code>test.html?exam=ssc&topic=math</code>";
    console.error("Missing exam or topic in URL");
} else {
    // Construct Path
    const dbPath = `tests/${exam}/${topic}/questions`;
    console.log("Fetching from Database Path:", dbPath);
    
    document.getElementById("question").innerText = "Loading questions from database...";

    // Fetch Data
    firebase.database()
    .ref(dbPath)
    .once("value")
    .then(snapshot => {
        if (!snapshot.exists()) {
            document.getElementById("question").innerText = "No questions found at path: " + dbPath;
            console.warn("Path exists but no data found.");
            return;
        }

        const data = snapshot.val();
        // Convert object to array if necessary (handles both array and object structures)
        if (Array.isArray(data)) {
            questions = data.filter(q => q); // Remove empty/null slots
        } else {
            questions = Object.values(data);
        }

        if (questions.length === 0) {
            document.getElementById("question").innerText = "Folder found but question list is empty.";
            return;
        }

        document.getElementById("testTitle").innerText = exam.replace("_", " ").toUpperCase() + " Test";
        loadQuestion();
        startTimer();
    })
    .catch(error => {
        console.error("Firebase Error:", error);
        document.getElementById("question").innerText = "Error loading data: " + error.message;
    });
}

/* ================= FUNCTIONS ================= */
function loadQuestion(){
    if (!questions[current]) return; // Safety check
    
    const q = questions[current];
    document.getElementById("question").innerText = `Q${current+1}. ${q.q}`;
    
    const optDiv = document.getElementById("options");
    optDiv.innerHTML = "";
    
    // Handle options whether they are an Array or Object
    const optionsKeys = Object.keys(q.options);
    
    optionsKeys.forEach(i => {
        let div = document.createElement("div");
        div.className = "option";
        div.innerText = q.options[i]; // Value
        
        // Check selection
        if (userAnswers[current] == i) div.classList.add("selected");
        
        div.onclick = () => {
            userAnswers[current] = i;
            loadQuestion(); // Refresh UI
        };
        optDiv.appendChild(div);
    });
}

function nextQuestion(){
    if(current < questions.length - 1){
        current++;
        loadQuestion();
    }
}

function prevQuestion(){
    if(current > 0){
        current--;
        loadQuestion();
    }
}

function skipQuestion(){
    if(current < questions.length - 1){
        current++;
        loadQuestion();
    }
}

function finishTest(){
    clearInterval(timer);
    document.getElementById("quiz").style.display = "none";
    document.getElementById("result").style.display = "block";

    questions.forEach((q, i) => {
        if (userAnswers[i] == q.answer) score++;
        else if (userAnswers[i] != undefined) score -= 0.33;
    });

    document.getElementById("scoreText").innerText =
        `Score: ${score.toFixed(2)} / ${questions.length}`;

    showReview();
}

function showReview(){
    const r = document.getElementById("review");
    r.innerHTML = "";
    questions.forEach((q, i) => {
        let html = `<b>Q${i+1}. ${q.q}</b>`;
        Object.keys(q.options).forEach(o => {
            let cls = "";
            if (o == q.answer) cls = "correct";
            else if (userAnswers[i] == o) cls = "wrong";
            
            // Highlight selected wrong answer vs correct answer
            html += `<div class="option ${cls}">${q.options[o]}</div>`;
        });
        html += `<div class="explanation"><b>Exp:</b> ${q.explanation || "No explanation provided."}</div><hr>`;
        r.innerHTML += html;
    });
}

function startTimer(){
    timer = setInterval(() => {
        if(time <= 0){ finishTest(); return; }
        time--;
        let m = Math.floor(time / 60);
        let s = time % 60;
        document.getElementById("time").innerText = `${m}:${s < 10 ? "0" : ""}${s}`;
    }, 1000);
}
</script>

</body>
</html>
