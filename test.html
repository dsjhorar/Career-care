<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Career Care Test</title>

<!-- Firebase -->
<script src="firebase.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  margin:0;
  padding:12px;
}
h2,h3{margin:8px 0}

#timer{
  font-weight:bold;
  color:#d32f2f;
}

.option{
  background:#ffffff;
  padding:12px;
  margin:8px 0;
  border-radius:8px;
  border:1px solid #ddd;
  cursor:pointer;
}

.option.selected{background:#cceeff}
.option.correct{background:#b6f2c1}
.option.wrong{background:#f7b2b2}

.controls{
  margin-top:10px;
}

button{
  padding:10px 14px;
  margin:5px 4px;
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
}

.btn-prev{background:#90caf9}
.btn-skip{background:#ffe082}
.btn-next{background:#a5d6a7}
.btn-submit{background:#ef9a9a}

#explanation{
  display:none;
  background:#ffffff;
  padding:10px;
  border-radius:6px;
  margin-top:10px;
}

#score{
  margin-top:12px;
  font-weight:bold;
}
</style>
</head>

<body>

<h2 id="testTitle">Loading Test...</h2>
<p>⏱ Time: <span id="timer">00:00</span></p>

<h3 id="question">Loading...</h3>
<div id="options"></div>

<div class="controls">
  <button class="btn-prev" onclick="prevQ()">⬅ Previous</button>
  <button class="btn-skip" onclick="skipQ()">⏭ Skip</button>
  <button class="btn-next" onclick="nextQ()">Next ➡</button>
  <button class="btn-submit" onclick="submitTest()">Submit</button>
</div>

<div id="explanation"></div>
<div id="score"></div>

<script>
  
/* ================================
   URL PARAMETERS (DYNAMIC)
================================ */
const params = new URLSearchParams(window.location.search);
const exam  = params.get("exam");   // first_grade
const topic = params.get("topic");  // topic_intro

if(!exam || !topic){
  alert("Invalid test link");
}

/* ================================
   FIREBASE PATH
   tests/{exam}/{topic}/questions
================================ */
const dbPath = `tests/${exam}/${topic}/questions`;

/* ================================
   VARIABLES
================================ */
let questions = [];
let current = 0;
let answers = {};
let submitted = false;
let score = 0;

/* TEMP USER (login step me dynamic hoga) */
// OLD: let userMobile = "9999999999";
// NEW: get from URL
const urlParams = new URLSearchParams(window.location.search);
let userMobile = urlParams.get("mobile") || "9999999999";

/* ================================
   TIMER
================================ */
let seconds = 0;
setInterval(()=>{
  seconds++;
  let m = String(Math.floor(seconds/60)).padStart(2,"0");
  let s = String(seconds%60).padStart(2,"0");
  document.getElementById("timer").innerText = m+":"+s;
},1000);

/* ================================
   LOAD QUESTIONS
================================ */
firebase.database().ref(dbPath).once("value",snap=>{
  snap.forEach(child=>{
    questions.push(child.val());
  });

  document.getElementById("testTitle").innerText =
    exam.replaceAll("_"," ").toUpperCase() + " Test";

  if(questions.length === 0){
    document.getElementById("question").innerText = "No questions found";
    return;
  }

  loadQuestion();
});

/* ================================
   LOAD QUESTION
================================ */
function loadQuestion(){
  let q = questions[current];
  document.getElementById("question").innerText =
    (current+1) + ". " + q.q;

  let html = "";
  Object.keys(q.options).forEach(i=>{
    let cls = "option";
    if(answers[current] == i) cls += " selected";

    if(submitted){
      if(i == q.answer) cls += " correct";
      else if(answers[current] == i) cls += " wrong";
    }

    html += `<div class="${cls}" onclick="selectOption(${i})">
              ${q.options[i]}
            </div>`;
  });

  document.getElementById("options").innerHTML = html;

  if(submitted){
    document.getElementById("explanation").style.display="block";
    document.getElementById("explanation").innerHTML =
      "<b>Explanation:</b> " + (q.explanation || "Not available");
  }else{
    document.getElementById("explanation").style.display="none";
  }
}

/* ================================
   OPTION SELECT
================================ */
function selectOption(i){
  if(submitted) return;
  answers[current] = i;
  loadQuestion();
}

/* ================================
   NAVIGATION
================================ */
function nextQ(){
  if(current < questions.length-1){
    current++;
    loadQuestion();
  }
}

function prevQ(){
  if(current > 0){
    current--;
    loadQuestion();
  }
}

function skipQ(){
  if(current < questions.length-1){
    current++;
    loadQuestion();
  }
}

/* ================================
   SUBMIT TEST
================================ */
function submitTest(){
  if(submitted) return;
  submitted = true;

  let correct=0, wrong=0, skipped=0;
  score = 0;

  questions.forEach((q,i)=>{
    if(answers[i] === undefined){
      skipped++;
    }else if(answers[i] == q.answer){
      correct++;
      score += 1;
    }else{
      wrong++;
      score -= 0.33;
    }
  });

  document.getElementById("score").innerText =
    `Score: ${score.toFixed(2)} | Correct: ${correct} | Wrong: ${wrong} | Skipped: ${skipped}`;

  /* SAVE RESULT */
  firebase.database().ref(
    `results/${userMobile}/${exam}/${topic}`
  ).push({
    score: score.toFixed(2),
    correct,
    wrong,
    skipped,
    time: document.getElementById("timer").innerText,
    date: new Date().toLocaleString()
  });

  loadQuestion();
}
  firebase.database().ref("students/"+userMobile+"/premium")
.once("value",snap=>{
  if(snap.val()!==true){
    alert("This is a premium test");
    window.location = "premium.html?mobile="+userMobile;
  }
});
</script>

</body>
</html>
