<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Career Care - Test</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #question-container { margin-bottom: 20px; }
    .option-btn { display: block; margin: 5px 0; padding: 10px; width: 100%; }
    #timer { font-size: 18px; margin-bottom: 10px; }
    #back-btn, #skip-btn, #submit-btn { margin-right: 10px; padding: 10px 15px; }
    #explanation-container { margin-top: 10px; font-style: italic; }
    #score-container { margin-top: 20px; font-size: 20px; font-weight: bold; }
  </style>
</head>
<body>

<h2>Test</h2>

<div id="question-container">
  <div id="timer">00:00</div>
  <div id="question-text"></div>
  <div id="options-container"></div>
</div>

<button id="back-btn">Back</button>
<button id="skip-btn">Skip</button>
<button id="submit-btn">Submit</button>

<div id="explanation-container"></div>
<div id="score-container"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>

<script>
  // ðŸ”¹ Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyBCuefZt2WuNsNiFme8M-HUHm_BZYKJAi4",
    authDomain: "career-care-afb64.firebaseapp.com",
    databaseURL: "https://career-care-afb64-default-rtdb.firebaseio.com",
    projectId: "career-care-afb64",
    storageBucket: "career-care-afb64.firebasestorage.app",
    messagingSenderId: "267890746286",
    appId: "1:267890746286:web:2c38f0980119d01b145e3f"
  };
  firebase.initializeApp(firebaseConfig);

  // ðŸ”¹ Variables
  var examPath = "tests/first_grade/topic_intro/questions"; // Change dynamically
  var questions = [];
  var currentQ = 0;
  var score = 0;
  var timerInterval;
  var timePerQuestion = 60;
  var timeLeft = timePerQuestion;
  var userAnswers = []; // Track answers

  // ðŸ”¹ Fetch Questions
  function fetchQuestions() {
  firebase.database().ref(examPath).once("value")
    .then(snapshot => {

      if (!snapshot.exists()) {
        alert("âŒ No questions found in Firebase!");
        return;
      }

      questions = [];
      userAnswers = [];

      snapshot.forEach(child => {
        questions.push(child.val());
        userAnswers.push({
          selected: null,
          correct: null,
          skipped: false
        });
      });

      if (questions.length === 0) {
        alert("âŒ Questions empty!");
        return;
      }

      displayQuestion();
      startTimer();
    })
    .catch(error => {
      alert("Firebase Error: " + error.message);
    });
  }

  // ðŸ”¹ Display Question
  function displayQuestion() {
    if(currentQ >= questions.length){
      endTest();
      return;
    }
    timeLeft = timePerQuestion;
    document.getElementById("timer").innerText = formatTime(timeLeft);
    let q = questions[currentQ];
    document.getElementById("question-text").innerText = q.q;
    let optionsHtml = "";
    for(let i=0;i<4;i++){
      optionsHtml += `<button class="option-btn" data-index="${i}">${q.options[i]}</button>`;
    }
    document.getElementById("options-container").innerHTML = optionsHtml;
    document.querySelectorAll(".option-btn").forEach(btn=>{
      btn.addEventListener("click", optionClick);
    });

    if(userAnswers[currentQ].selected !== null){
      showAnswerFeedback(currentQ);
    } else {
      document.getElementById("explanation-container").innerText = "";
    }

    updateNavigationButtons();
  }

  function updateNavigationButtons(){
    document.getElementById("back-btn").style.display = currentQ>0 ? "inline-block":"none";
    document.getElementById("skip-btn").style.display = currentQ<questions.length ? "inline-block":"none";
  }

  // ðŸ”¹ Option Click
  function optionClick(e){
    clearInterval(timerInterval);
    let selected = parseInt(e.target.dataset.index);
    let q = questions[currentQ];

    userAnswers[currentQ] = { selected: selected, correct: (selected===q.answer), skipped: false };
    calculateScore(currentQ);
    showAnswerFeedback(currentQ);

    setTimeout(()=>{
      if(currentQ < questions.length-1){
        currentQ++;
        displayQuestion();
        startTimer();
      } else {
        endTest();
      }
    },3000);
  }

  // ðŸ”¹ Calculate Score
  function calculateScore(index){
    let ua = userAnswers[index];
    if(ua.correct) score +=1;
    else if(ua.selected !== null && !ua.correct) score -= 1/3;
  }

  // ðŸ”¹ Show Answer Feedback
  function showAnswerFeedback(index){
    let q = questions[index];
    let ua = userAnswers[index];
    document.querySelectorAll(".option-btn").forEach((btn,i)=>{
      if(i == q.answer) btn.style.backgroundColor = "green";
      else if(i === ua.selected) btn.style.backgroundColor = "red";
      else btn.style.backgroundColor = "";
      btn.disabled = true;
    });
    document.getElementById("explanation-container").innerText = ua.skipped ? "Skipped" : q.explanation;
  }

  // ðŸ”¹ Timer
  function startTimer(){
    clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
      timeLeft--;
      document.getElementById("timer").innerText = formatTime(timeLeft);
      if(timeLeft <=0){
        clearInterval(timerInterval);
        skipQuestion();
      }
    },1000);
  }

  function skipQuestion(){
    userAnswers[currentQ].skipped = true;
    userAnswers[currentQ].selected = null;
    userAnswers[currentQ].correct = false;
    showAnswerFeedback(currentQ);
    setTimeout(()=>{
      if(currentQ < questions.length-1){
        currentQ++;
        displayQuestion();
        startTimer();
      } else {
        endTest();
      }
    },1000);
  }

  // ðŸ”¹ Navigation Buttons
  document.getElementById("back-btn").addEventListener("click", ()=>{
    if(currentQ>0){
      currentQ--;
      displayQuestion();
      startTimer();
    }
  });

  document.getElementById("skip-btn").addEventListener("click", ()=>{ skipQuestion(); });

  document.getElementById("submit-btn").addEventListener("click", endTest);

  // ðŸ”¹ End Test
  function endTest(){
    clearInterval(timerInterval);
    document.getElementById("question-container").style.display = "none";
    document.getElementById("submit-btn").style.display = "none";
    document.getElementById("score-container").innerText = `Score: ${score.toFixed(2)} / ${questions.length}`;

    var userId = firebase.auth().currentUser.uid;
    firebase.database().ref(`results/${userId}/first_grade`).set({
      score: score,
      total: questions.length,
      timestamp: Date.now()
    });
  }

  function formatTime(sec){
    let m = Math.floor(sec/60);
    let s = sec%60;
    return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  }

  fetchQuestions();
</script>
</body>
</html>
