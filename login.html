<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login - Career Care</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
  body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f4f6f8; display:flex; justify-content:center; align-items:center; height:100vh; margin:0;}
  .card{background:white; padding:30px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); width:100%; max-width:350px; text-align:center;}
  h2{color:#1e88e5; margin-bottom:20px;}
  input{padding:12px; margin:10px 0; border:1px solid #ddd; border-radius:6px; width:90%; font-size:16px;}
  button{padding:12px; margin-top:10px; border:none; border-radius:6px; cursor:pointer; width:100%; font-size:16px; font-weight:bold; color:white; background:#1e88e5;}
  button:hover{background:#1565c0;}
  #recaptcha-container{margin-top:10px;}
</style>
</head>
<body>

<div class="card">
  <h2>Student Login</h2>

  <div id="loginDiv">
    <input type="number" id="mobile" placeholder="Mobile Number (10 digits)" maxlength="10">
    <div id="recaptcha-container"></div>
    <button onclick="sendOTP()" id="sendBtn">Send OTP</button>
  </div>

  <div id="otpDiv" style="display:none">
    <p>OTP sent to <span id="sentMobile"></span></p>
    <input type="number" id="otp" placeholder="Enter 6-digit OTP">
    <button onclick="verifyOTP()">Verify & Login</button>
  </div>
</div>

<script>
/* ================= CONFIGURATION ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBCuefZt2WuNsNiFme8M-HUHm_BZYKJAi4",
  authDomain: "career-care-afb64.firebaseapp.com",
  databaseURL: "https://career-care-afb64-default-rtdb.firebaseio.com",
  projectId: "career-care-afb64",
  storageBucket: "career-care-afb64.firebasestorage.app",
  messagingSenderId: "267890746286",
  appId: "1:267890746286:web:2c38f0980119d01b145e3f"
};
firebase.initializeApp(firebaseConfig);

let confirmationResult;

function sendOTP(){
  let mobile = document.getElementById("mobile").value;
  if(mobile.length != 10){ alert("Please enter valid 10 digit number"); return; }

  // Button disable karein taaki user baar baar click na kare
  document.getElementById("sendBtn").innerText = "Sending...";
  document.getElementById("sendBtn").disabled = true;

  if(!window.recaptchaVerifier){
    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
      'size': 'invisible'
    });
  }

  firebase.auth().signInWithPhoneNumber("+91"+mobile, window.recaptchaVerifier)
  .then(function(result){
    confirmationResult = result;
    document.getElementById("loginDiv").style.display="none";
    document.getElementById("otpDiv").style.display="block";
    document.getElementById("sentMobile").innerText = "+91 " + mobile;
  }).catch(function(error){
    console.error(error);
    alert("Error: " + error.message);
    document.getElementById("sendBtn").innerText = "Send OTP";
    document.getElementById("sendBtn").disabled = false;
  });
}

function verifyOTP(){
  let code = document.getElementById("otp").value;
  
  confirmationResult.confirm(code).then(function(result){
    let user = result.user;
    let mobileKey = user.phoneNumber.replace("+91", ""); // remove +91 for database key

    // Database Reference
    const userRef = firebase.database().ref("students/" + mobileKey);

    // Check karein: Kya user pehle se hai?
    userRef.once('value').then(snapshot => {
      if(snapshot.exists()){
        // USER PURANA HAI:
        // Sirf login karein, data overwrite na karein (taaki Premium status na hate)
        let data = snapshot.val();
        localStorage.setItem("userMobile", mobileKey);
        localStorage.setItem("isPremium", data.isPremium); // Save status locally
        alert(`Welcome back! You are a ${data.isPremium ? 'Premium' : 'Free'} user.`);
        window.location = "index.html";
      } else {
        // USER NAYA HAI:
        // Default 'isPremium: false' set karein
        userRef.set({
          uid: user.uid,
          mobile: user.phoneNumber,
          isPremium: false,   // <--- IMPORTANT: By default FREE
          joinDate: new Date().toISOString()
        }).then(() => {
          localStorage.setItem("userMobile", mobileKey);
          localStorage.setItem("isPremium", "false");
          alert("Login Successful! Account Created.");
          window.location = "index.html";
        });
      }
    });

  }).catch(function(error){
    alert("Invalid OTP");
  });
}
</script>

</body>
</html>
